language: android
jdk: oraclejdk8
sudo: false

if: type == pull_request OR tag IS present

env:
  global:
  - ANDROID_API_LEVEL=28
  - ANDROID_BUILD_TOOLS_VERSION=28.0.3
  - ANDROID_ABI=x86

android:
  components:
  - tools
  - platform-tools
  - android-$ANDROID_API_LEVEL
  - build-tools-$ANDROID_BUILD_TOOLS_VERSION
  - sys-img-$ANDROID_ABI-google_apis-$ANDROID_API_LEVEL

licenses:
- android-sdk-preview-license-.+
- android-sdk-license-.+
- google-gdk-license-.+

cache:
  directories:
  - $HOME/.gradle/caches/
  - $HOME/.gradle/wrapper/
  - $HOME/.android/build-cache

before_install:
- yes | sdkmanager "platforms;android-28"

stages:
- name: compile and test uikit
- name: compile and test modules
- name: compile and test samples
- name: ui tests
- name: deploy
  if: tag =~ ^\d+\.\d+\.\d+$

jobs:
  include:
  - stage: compile and test uikit
    name: common
    script: ./gradlew :uikit-common:check
  - stage: compile and test uikit
    name: common-sdk
    script: ./gradlew :uikit-common-sdk:check
  - stage: compile and test uikit
    name: compass
    script: ./gradlew :uikit-compass:check
  - stage: compile and test uikit
    name: compass-viewmodel
    script: ./gradlew :uikit-compass-viewmodel:check
  - stage: compile and test uikit
    name: poidetail
    script: ./gradlew :uikit-poidetail:check
  - stage: compile and test uikit
    name: positionlockfab
    script: ./gradlew :uikit-positionlockfab:check
  - stage: compile and test uikit
    name: positionlockfab-viewmodel
    script: ./gradlew :uikit-positionlockfab-viewmodel:check
  - stage: compile and test uikit
    name: zoomcontrols
    script: ./gradlew :uikit-zoomcontrols:check
  - stage: compile and test uikit
    name: zoomcontrols-viewmodel
    script: ./gradlew :uikit-zoomcontrols-viewmodel:check

  - stage: compile and test modules
    name: common
    script: ./gradlew :modules-common:check
  - stage: compile and test modules
    name: browsemap
    script: ./gradlew :modules-browsemap:check

  - stage: compile and test samples
    name: sample app
    script:
    - ./gradlew :app-samples:check

  - stage: ui tests
    name: browsemap-default
    before_script:
    - echo no | android create avd --force -n test -t android-$ANDROID_API_LEVEL --abi $ANDROID_ABI -c 400M
    - emulator -avd test -no-audio -no-window &
    - android-wait-for-emulator
    - adb shell input keyevent 82 &
    script: ./gradlew :app-samples-browsemap-default:connectedAndroidTest
  - stage: ui tests
    name: browsemap-full
    before_script:
    - echo no | android create avd --force -n test -t android-$ANDROID_API_LEVEL --abi $ANDROID_ABI -c 400M
    - emulator -avd test -no-audio -no-window &
    - android-wait-for-emulator
    - adb shell input keyevent 82 &
    script: ./gradlew :app-samples-browsemap-full:connectedAndroidTest
  - stage: ui tests
    name: browsemap-modes
    before_script:
    - echo no | android create avd --force -n test -t android-$ANDROID_API_LEVEL --abi $ANDROID_ABI -c 400M
    - emulator -avd test -no-audio -no-window &
    - android-wait-for-emulator
    - adb shell input keyevent 82 &
    script: ./gradlew :app-samples-browsemap-modes:connectedAndroidTest
  - stage: ui tests
    name: browsemap-markers
    before_script:
    - echo no | android create avd --force -n test -t android-$ANDROID_API_LEVEL --abi $ANDROID_ABI -c 400M
    - emulator -avd test -no-audio -no-window &
    - android-wait-for-emulator
    - adb shell input keyevent 82 &
    script: ./gradlew :app-samples-browsemap-markers:connectedAndroidTest
  - stage: ui tests
    name: browsemap-details-window
    before_script:
    - echo no | android create avd --force -n test -t android-$ANDROID_API_LEVEL --abi $ANDROID_ABI -c 400M
    - emulator -avd test -no-audio -no-window &
    - android-wait-for-emulator
    - adb shell input keyevent 82 &
    script: ./gradlew :app-samples-browsemap-details-window:connectedAndroidTest
  - stage: ui tests
    name: browsemap-click-listener
    before_script:
    - echo no | android create avd --force -n test -t android-$ANDROID_API_LEVEL --abi $ANDROID_ABI -c 400M
    - emulator -avd test -no-audio -no-window &
    - android-wait-for-emulator
    - adb shell input keyevent 82 &
    script: ./gradlew :app-samples-browsemap-click-listener:connectedAndroidTest
  - stage: ui tests
    name: browsemap-themes
    before_script:
    - echo no | android create avd --force -n test -t android-$ANDROID_API_LEVEL --abi $ANDROID_ABI -c 400M
    - emulator -avd test -no-audio -no-window &
    - android-wait-for-emulator
    - adb shell input keyevent 82 &
    script: ./gradlew :app-samples-browsemap-themes:connectedAndroidTest

  - stage: deploy
    name: assembleRelease
    script:
    - ./gradlew assembleRelease -P"sygic.sdk.key"=$SYGIC_API_KEY #todo credentials?
    deploy:
      provider: script #todo provider: releases
      script: echo 'deploing job done' #todo real deploy ;)
      file: $TRAVIS_BUILD_DIR/app/samples/build/outputs/apk/release/app-samples-arm64-v8a-release.apk
      skip_cleanup: true
    after_deploy:
    - rm -rf $TRAVIS_BUILD_DIR/app/samples/build/outputs
